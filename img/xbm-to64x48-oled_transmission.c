/************************************************
xbm2bin.c  // xbm (nicht x10 format)
************************************************/
#include <stdio.h>
#include <stdlib.h>

#define SHORT_LENGTH 8
#define BYTE_LENGTH 8

// Name of defined image
#define NAME top_bits

// Filename to write to
#define FILENAME "line_bits.bin"

// Invert image
#define INVERT 1

#define top_width 64
#define top_height 48
static unsigned char top_bits[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0x3f, 0xdb, 0x76, 0x33, 0xb7, 0xfd, 0x1f, 0xf8, 0xff, 0xca, 0x26,
   0xed, 0x96, 0xfd, 0x1f, 0xf8, 0x9f, 0xd2, 0x56, 0xed, 0xa6, 0xfd, 0x1f,
   0xf8, 0xdf, 0xda, 0x76, 0xed, 0xb6, 0xfd, 0x1f, 0xf8, 0x3f, 0xdb, 0x76,
   0x33, 0xb7, 0xfd, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0x68, 0xb3, 0x10, 0xda, 0x85, 0x36, 0x4f, 0x10, 0x28, 0xad, 0x73, 0x9a,
   0x9c, 0x32, 0xd7, 0x1d, 0x48, 0xad, 0xbd, 0x5b, 0xed, 0xd4, 0xce, 0x1d,
   0x68, 0xad, 0xd6, 0xda, 0xb5, 0x16, 0xd6, 0x1d, 0x68, 0xb3, 0x39, 0xdb,
   0xcd, 0xd6, 0xda, 0x1d, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
   0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
 };

void printDisplay(unsigned char * display) {
	int i,j;
	for( i=0; i<top_height; i++){
		for( j=0; j<top_width; j++){
			if (display[i*top_width+j] != 0)
				printf("X");
			else
				printf(" ");
		}
		printf("\n");
	}
	printf("\n");
}

int write_to_file(unsigned char * display, char * filename) {
	FILE * fp;
	fp = fopen(filename, "w");
	if (fp == NULL)
		return -1;

	int i, j, k;
	unsigned char tmp;
	for (i=0; i<top_height; i=i+BYTE_LENGTH) {
		for(j=(top_width-1); j>=0; j--) {
			tmp = 0;
			for( k=0; k<BYTE_LENGTH; k++){
				tmp = tmp+(display[(i+k)*top_width+j] << k);
			}
			fwrite(&tmp, 1, 1, fp);
		}
	}

	fclose(fp);
	return 0;
}

int print_file(char * filename) {
	FILE * fp;
	fp = fopen(filename, "r");
	if (fp == NULL)
		return -1;

	int i;
	unsigned char tmp;
	for (i=0; i<(top_height*top_width/8); i++) {
		tmp = 0;
		fread(&tmp, 1, 1, fp);
		printf("0x%X, ", tmp);
	}

	fclose(fp);
	return 0;
}

unsigned char * expandBitMap(
	unsigned char * bits,
	unsigned char * display
) {
	int i,j;
	for (i = 0; i<(top_width*top_height/SHORT_LENGTH); i++) {
		for (j=0; j<SHORT_LENGTH; j++) {
			display[i*SHORT_LENGTH + j] = (bits[i] & (1 << j)) >> j;
			if (INVERT == 1) {
				if (display[i*SHORT_LENGTH + j] == 0)
					display[i*SHORT_LENGTH + j] = 1;
				else
					display[i*SHORT_LENGTH + j] = 0;
			}
		}
	}
	return display;
}

int main() {
	unsigned char * display = malloc(top_width*top_height);
	display = expandBitMap(NAME,display);
	printDisplay(display);
	write_to_file(display, FILENAME);
	print_file(FILENAME);
	free(display);
	return 0;
}
